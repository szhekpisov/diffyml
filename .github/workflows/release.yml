name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Validate semver tag
        run: |
          TAG="${GITHUB_REF_NAME}"
          if [[ ! "${TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Tag '${TAG}' does not match strict semver format vMAJOR.MINOR.PATCH"
            exit 1
          fi
          echo "Tag '${TAG}' is valid semver"

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          persist-credentials: false

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: "1.25.7"
          cache: false

      - name: Run tests
        run: go test ./...

      - name: Run vet
        run: go vet ./...

      - name: Verify version output
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          go build -ldflags "-s -w -X main.version=${VERSION} -X main.commit=${GITHUB_SHA} -X main.buildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" -o diffyml_verify
          OUTPUT=$(./diffyml_verify --version)
          echo "Version output: ${OUTPUT}"
          if [[ "${OUTPUT}" != *"${VERSION}"* ]]; then
            echo "::error::Version output does not contain expected version '${VERSION}'"
            exit 1
          fi
          echo "Version verification passed"
          rm -f diffyml_verify

  release:
    needs: verify
    runs-on: ubuntu-latest
    outputs:
      hashes: ${{ steps.hash.outputs.hashes }}
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: "1.25.7"
          cache: false

      - name: Run GoReleaser
        id: goreleaser
        uses: goreleaser/goreleaser-action@ec59f474b9834571250b370d4735c50f8e2d1e29
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate subject hashes for SLSA provenance
        id: hash
        env:
          ARTIFACTS: "${{ steps.goreleaser.outputs.artifacts }}"
        run: |
          checksum_file=$(echo "$ARTIFACTS" | jq -r '.[] | select (.type=="Checksum") | .path')
          echo "hashes=$(cat "$checksum_file" | base64 -w0)" >> "$GITHUB_OUTPUT"

      - name: Attest build provenance
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-checksums: ./dist/checksums.txt

  provenance:
    needs: release
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0 # zizmor: ignore[unpinned-uses]
    with:
      base64-subjects: "${{ needs.release.outputs.hashes }}"
      upload-assets: true

  update-changelog:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: false

      - name: Generate changelog
        uses: orhun/git-cliff-action@c93ef52f3d0ddcdcc9bd5447d98d458a11cd4f72 # v4
        with:
          config: cliff.toml
          args: --output CHANGELOG.md

      - name: Commit and push changelog
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git add CHANGELOG.md
          if git diff --cached --quiet; then
            echo "No changelog changes to commit"
            exit 0
          fi
          git commit -m "chore: update CHANGELOG.md for ${TAG}"
          git push

  update-tap:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          persist-credentials: false

      - name: Extract version
        id: version
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Download source tarball and compute SHA256
        id: checksum
        env:
          TAG: ${{ steps.version.outputs.tag }}
        run: |
          curl -sL -o source.tar.gz "https://github.com/szhekpisov/diffyml/archive/refs/tags/${TAG}.tar.gz"
          SHA256=$(sha256sum source.tar.gz | awk '{print $1}')
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"
          echo "SHA256: ${SHA256}"
          rm -f source.tar.gz

      - name: Clone tap repository
        run: |
          git clone "https://x-access-token:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/szhekpisov/homebrew-diffyml.git" tap

      - name: Generate formula from template
        env:
          VERSION: ${{ steps.version.outputs.version }}
          SHA256: ${{ steps.checksum.outputs.sha256 }}
        run: |
          mkdir -p tap/Formula
          sed -e "s/VERSION/${VERSION}/g" -e "s/SHA256/${SHA256}/g" homebrew/diffyml.rb.template > tap/Formula/diffyml.rb
          echo "Generated formula:"
          cat tap/Formula/diffyml.rb

      - name: Validate formula syntax
        run: ruby -c tap/Formula/diffyml.rb

      - name: Commit and push
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/diffyml.rb
          git commit -m "Update diffyml to ${VERSION}"
          git push
