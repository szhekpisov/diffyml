name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions: read-all

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Validate semver tag
        run: |
          TAG="${GITHUB_REF_NAME}"
          if [[ ! "${TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Tag '${TAG}' does not match strict semver format vMAJOR.MINOR.PATCH"
            exit 1
          fi
          echo "Tag '${TAG}' is valid semver"

      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: "1.25.7"

      - name: Run tests
        run: go test ./...

      - name: Run vet
        run: go vet ./...

      - name: Verify version output
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          go build -ldflags "-s -w -X main.version=${VERSION} -X main.commit=${GITHUB_SHA} -X main.buildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" -o diffyml_verify
          OUTPUT=$(./diffyml_verify --version)
          echo "Version output: ${OUTPUT}"
          if [[ "${OUTPUT}" != *"${VERSION}"* ]]; then
            echo "::error::Version output does not contain expected version '${VERSION}'"
            exit 1
          fi
          echo "Version verification passed"
          rm -f diffyml_verify

  release:
    needs: verify
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v6
        with:
          go-version: "1.25.7"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@ec59f474b9834571250b370d4735c50f8e2d1e29
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-changelog:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0

      - name: Generate changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --output CHANGELOG.md

      - name: Commit and push changelog
        run: |
          TAG="${GITHUB_REF_NAME}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          if git diff --cached --quiet; then
            echo "No changelog changes to commit"
            exit 0
          fi
          git commit -m "docs: update CHANGELOG.md for ${TAG}"
          git push

  update-tap:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Extract version
        id: version
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Download source tarball and compute SHA256
        id: checksum
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          curl -sL -o source.tar.gz "https://github.com/szhekpisov/diffyml/archive/refs/tags/${TAG}.tar.gz"
          SHA256=$(sha256sum source.tar.gz | awk '{print $1}')
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"
          echo "SHA256: ${SHA256}"
          rm -f source.tar.gz

      - name: Clone tap repository
        run: |
          git clone "https://x-access-token:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/szhekpisov/homebrew-diffyml.git" tap

      - name: Generate formula from template
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHA256="${{ steps.checksum.outputs.sha256 }}"
          mkdir -p tap/Formula
          sed -e "s/VERSION/${VERSION}/g" -e "s/SHA256/${SHA256}/g" homebrew/diffyml.rb.template > tap/Formula/diffyml.rb
          echo "Generated formula:"
          cat tap/Formula/diffyml.rb

      - name: Validate formula syntax
        run: ruby -c tap/Formula/diffyml.rb

      - name: Commit and push
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/diffyml.rb
          git commit -m "Update diffyml to ${VERSION}"
          git push
