name: Tests

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          persist-credentials: false

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: "1.25.7"

      - name: Run tests
        run: go test ./...

  fuzz:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          persist-credentials: false

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: "1.25.7"

      - name: Run fuzz tests
        run: |
          for target in FuzzCompare FuzzCompareWithOptions FuzzParseWithOrder FuzzDocumentParser; do
            echo "=== Fuzzing $target for 30s ==="
            go test -fuzz="^${target}$" -fuzztime=30s -run='^$' ./pkg/diffyml/
          done

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          persist-credentials: false

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: "1.25.7"

      - name: Run tests with coverage
        run: go test ./pkg/diffyml/ -coverprofile=coverage.out

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        with:
          files: coverage.out
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Check coverage thresholds
        run: |
          set -euo pipefail

          get_file_coverage() {
            local file="$1"
            awk -F'[ ]' -v f="/${file}:" '$0 ~ f {
              total += $(NF-1)
              if ($NF > 0) covered += $(NF-1)
            } END {
              printf "%.1f", (total > 0 ? covered * 100 / total : 0)
            }' coverage.out
          }

          PARSER_COV=$(get_file_coverage "parser.go")
          ORDERED_MAP_COV=$(get_file_coverage "ordered_map.go")
          KUBERNETES_COV=$(get_file_coverage "kubernetes.go")

          echo ""
          echo "=== Coverage Summary ==="
          printf "%-20s %8s %10s %s\n" "File" "Actual" "Required" "Status"
          printf "%-20s %8s %10s %s\n" "----" "------" "--------" "------"

          FAIL=0

          check_threshold() {
            local file="$1" actual="$2" required="$3"
            local status="PASS"
            if [ "$(echo "$actual < $required" | bc -l)" -eq 1 ]; then
              status="FAIL"
              FAIL=1
            fi
            printf "%-20s %7s%% %9s%% %s\n" "$file" "$actual" "$required" "$status"
          }

          check_threshold "parser.go"      "$PARSER_COV"      "100.0"
          check_threshold "ordered_map.go"  "$ORDERED_MAP_COV" "100.0"
          check_threshold "kubernetes.go"   "$KUBERNETES_COV"  "99.0"

          echo ""

          if [ "$FAIL" -eq 1 ]; then
            echo "Coverage threshold check FAILED"
            exit 1
          fi

          echo "All coverage thresholds passed"
