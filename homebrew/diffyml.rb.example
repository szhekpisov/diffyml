# Example Homebrew Formula for diffyml
#
# This is an example formula showing how diffyml will be packaged for Homebrew.
# It is NOT a functional formula - URLs and checksums need to be updated
# for each release.
#
# To use this formula:
# 1. Replace USER with your GitHub username
# 2. Replace VERSION with the actual version (e.g., 1.0.0)
# 3. Calculate the SHA256 checksum of the release tarball
# 4. Submit to homebrew/core or create a custom tap
#
# For more information, see:
# - https://docs.brew.sh/Formula-Cookbook
# - https://docs.brew.sh/Acceptable-Formulae

class Diffyml < Formula
  desc "A diff tool for YAML files with human-readable output"
  homepage "https://github.com/USER/diffyml"
  url "https://github.com/USER/diffyml/archive/refs/tags/vVERSION.tar.gz"
  sha256 "CHECKSUM_PLACEHOLDER"
  license "MIT"
  head "https://github.com/USER/diffyml.git", branch: "main"

  # Build dependency - Go is required to compile from source
  depends_on "go" => :build

  def install
    # Set version information via ldflags
    ldflags = %W[
      -s -w
      -X main.version=#{version}
      -X main.commit=#{tap.user}
      -X main.buildDate=#{time.iso8601}
    ]

    # Build the binary
    system "go", "build", *std_go_args(ldflags:)
  end

  test do
    # Test 1: Verify version flag works
    assert_match version.to_s, shell_output("#{bin}/diffyml --version")

    # Test 2: Verify help flag works
    assert_match "Usage:", shell_output("#{bin}/diffyml --help")

    # Test 3: Test basic YAML diff functionality
    (testpath/"file1.yaml").write <<~YAML
      name: test
      value: 1
    YAML

    (testpath/"file2.yaml").write <<~YAML
      name: test
      value: 2
    YAML

    output = shell_output("#{bin}/diffyml #{testpath}/file1.yaml #{testpath}/file2.yaml", 1)
    assert_match "value", output
  end
end

# =============================================================================
# FORMULA METADATA REQUIREMENTS
# =============================================================================
#
# Required Fields:
# ----------------
# desc     - One-line description (max 80 chars, no "A/An" prefix)
# homepage - Project homepage URL
# url      - Source archive URL (tar.gz or zip)
# sha256   - SHA256 checksum of the source archive
# license  - SPDX license identifier (e.g., "MIT", "Apache-2.0")
#
# Build Configuration:
# -------------------
# depends_on "go" => :build  - Go is a build-time dependency only
# std_go_args               - Standard Go build arguments from Homebrew
# ldflags                   - Version injection via Go linker flags
#
# Test Block:
# ----------
# - Must verify the formula installs and runs correctly
# - Should test --version flag at minimum
# - Can test basic functionality with sample files
# - Exit code 1 is expected when files differ (not an error)
#
# =============================================================================
# HOW TO CREATE A RELEASE
# =============================================================================
#
# 1. Create a Git tag: git tag -a v1.0.0 -m "Release v1.0.0"
# 2. Push the tag: git push origin v1.0.0
# 3. Create a GitHub release from the tag
# 4. Get the tarball URL: https://github.com/USER/diffyml/archive/refs/tags/v1.0.0.tar.gz
# 5. Calculate SHA256: curl -sL <URL> | shasum -a 256
# 6. Update this formula with the new version and checksum
#
# =============================================================================
# SUBMITTING TO HOMEBREW
# =============================================================================
#
# Option 1: Submit to homebrew/core (requires meeting all criteria)
# - See: https://docs.brew.sh/Acceptable-Formulae
# - Fork homebrew/homebrew-core
# - Add formula to Formula/y/diffyml.rb
# - Submit a pull request
#
# Option 2: Create a custom tap
# - Create a repository named homebrew-tap (or similar)
# - Add the formula as Formula/diffyml.rb
# - Users install with: brew tap USER/tap && brew install diffyml
#
# =============================================================================
